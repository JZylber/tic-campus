<script type="module" id="campus-insertion">
  const subject = "Desarrollo de Aplicaciones InformÃ¡ticas";
  const course = "NR5A";
  let campusLink = encodeURI(
    `https://jzylber.github.io/tic-campus/${subject}/${course}`
  );
  const baseURL = "https://jzylber.github.io/";
  const fetchTagContent = (url) => {
    return fetch(url).then((response) => {
      return response.text();
    });
  };

  let campusHTML = await fetch(campusLink).then((response) => {
    return response.text();
  });
  // Clear parent and add shadow DOM
  let parent = document
    .getElementById("campus-insertion")
    .closest(".bodySitio");
  parent.id = "campus-insertion";
  parent.innerHTML = "";
  const shadow = parent.attachShadow({ mode: "open" });
  const parser = new DOMParser();
  const doc = parser.parseFromString(campusHTML, "text/html");
  // Append all link and style tags to head
  const linkTags = [...doc.querySelectorAll("link, style")].map((el) => {
    // All link tags with href that starts with /tic-campus should be added the base URL at the front
    if (el.href && el.href.startsWith("https://campus.ort.edu.ar/tic-campus")) {
      el.href = el.href.replace("https://campus.ort.edu.ar/", baseURL);
    } else {
      if (el.tagName === "LINK") {
        // Clone element and append it to head
        const newLink = el.cloneNode();
        newLink.href = el.href;
        document.head.appendChild(newLink);
      }
    }
    shadow.appendChild(el);
  });
  // Create a div tag with the id "leftoverinformation", display none and append all breadcrumbs and menu to it
  let leftoverDiv = document.createElement("div");
  leftoverDiv.style.display = "none";
  leftoverDiv.id = "leftoverinformation";
  let breadcrumbs = document.querySelectorAll("a.breadcrumb").forEach((el) => {
    leftoverDiv.innerHTML += el.outerHTML;
  });
  const triggerDOMContentLoaded = () => {
    document.dispatchEvent(new CustomEvent("DOMContentLoaded"));
  };
  // Get the div with classes col and s1 and add to the template
  let menu = document.querySelector(".col.s1 ul");
  if (menu) {
    leftoverDiv.innerHTML += menu.outerHTML;
  }
  body.appendChild(leftoverDiv);
  // Get all script tags
  let scripts = [...doc.querySelectorAll("script")];
  //Remove from doc
  scripts.forEach((el) => {
    el.remove();
  });
  //Set parents innerHTML to template + doc body innerHtml
  shadow.innerHTML += doc.body.innerHTML;
  scripts.forEach((el, index) => {
    const newScript = document.createElement("script");
    newScript.async = false;
    // If last script tag, trigger DOMContentLoaded
    if (index === scripts.length - 1) {
      newScript.addEventListener("load", triggerDOMContentLoaded);
    }
    // Copy all atributtes from the original script tag
    for (let i = 0; i < el.attributes.length; i++) {
      newScript.setAttribute(el.attributes[i].name, el.attributes[i].value);
    }
    // If the script tag has a src attribute, fetch the content and set it as innerText
    if (el.src) {
      // If the source is a relative path, add the base URL at the front
      if (el.src.startsWith("https://campus.ort.edu.ar/tic-campus")) {
        newScript.src = el.src.replace("https://campus.ort.edu.ar/", baseURL);
      }
    }
    newScript.innerText = el.innerText;
    shadow.appendChild(newScript);
  });
</script>
